<?php
//session_cache_limiter('nocache');
//session_start();
include("scripts/settings.php");
logvalidate('admin');
page_header_start();
$msg='';
if(isset($_GET['del'])){

$sql="DELETE FROM `form_fee` WHERE sno='".$_GET['del']."'";
$run=execute_query(connect(), $sql);
}
				
	$msg .= '<table>
	<tr>
		<th>Sno</th>
		<th>Student Name</th>
		<th>Father Name</th>
		<th>Date</th>
		<th>Gender</th>
		<th>Category</th>
		<th>Mobile</th>
		<th>Class</th>
		<th>Subject</th>
		<th>Form No.</th>
		<th>Email Id</th>
		<th>Receipt Number</th>
		<th>Amount</th>
		<th>Batch</th>
		<th>Type</th>
		<th>Generated By</th>
		<th>Edit</th>
		<th>Delete</th>
		<th>Print</th>		
	</tr>';
	
		
		$sql="select * from `form_fee` where 1=1";
		if($_SESSION['username'] != 'sadmin'){
			$sql .=" AND (`created_by` IS NULL OR `created_by`= '".$_SESSION['username']."') ";
		}
		if(isset($_POST['submit'])){
 			if($_POST['stu_name'] != ''){
 				$sql .= ' AND `stu_name` like "%'.$_POST['stu_name'].'%"';
 			}
 			if($_POST['father_name'] != ''){
 				$sql .= ' AND `father_name` like "%'.$_POST['father_name'].'%"';
 			}
 			if($_POST['form_no'] != ''){
 				$sql .= ' AND `form_no` like "%'.$_POST['form_no'].'%"';
 			}
 			if($_POST['class'] != ''){
 				$sql .= ' AND `class`="'.$_POST['class'].'"';
 			}
 			if($_POST['fee_submission_type'] != ''){
 				$sql .= ' AND `fee_submission_type`="'.$_POST['fee_submission_type'].'"';
 			}
 			if($_POST['gender'] != ''){
 				$sql .= ' AND `gender`="'.$_POST['gender'].'"';
 			}
 			if($_POST['category'] != ''){
 				$sql .= ' AND `category`="'.$_POST['category'].'"';
 			}
 			if($_POST['date_from'] != ''){
 				$sql .= ' AND `fee_submission_date`>="'.$_POST['date_from'].'"';
 			}
 			if($_POST['date_to'] != ''){
 				$sql .= ' AND `fee_submission_date`<="'.$_POST['date_to'].'"';
 			}
		}
		else{
			$sql .= ' AND `fee_submission_date`>="'.date('Y-m-d').'" AND `fee_submission_date`<="'.date('Y-m-d').'" ';
		}
              $i=1;
              $amount = 0;
             $run=execute_query(connect(), $sql);;
             while($row=mysqli_fetch_array($run)){
             	if ($row['created_by'] != '') {
			    	$sql_user = 'SELECT * FROM `user` WHERE `userid`="'.$row['created_by'].'"';
			    	$result_user = execute_query(connect(), $sql_user );
			    	$row_user = mysqli_fetch_array($result_user);
				}
             	if($row['fee_submission_type'] == "Admission Form"){
					$fee_type = 'ADM';
				}
				else if($row['fee_submission_type'] == "Duplicate Form"){
					$fee_type = 'DUP';
				}
				else if($row['fee_submission_type'] == "tc_cc"){
				    $fee_type = 'TCCC';
				}
				else if($row['fee_submission_type'] == "miscellaneous"){
				    $fee_type = 'MIS';
				}
				else if($row['fee_submission_type'] == "Research Inovation Fee"){
				    $fee_type = 'RIF';
				}
				$class_description = '';
				if ($row['class'] == "phd_commerce") {
					$class_description = "PHD COMMERCE";
				}
				elseif ($row['class'] == "phd_education") {
					$class_description = "PHD EDUCATION";
				}
				elseif ($row['class'] == "phd_english") {
					$class_description = "PHD ENGLISH";
				}
				elseif ($row['class'] == "phd_zoology") {
					$class_description = "PHD ZOOLOGY";
				}
				else{
             		$sql_class = 'SELECT * FROM `class_detail` WHERE `sno`="'.$row['class'].'"';
				  	$result_class = execute_query(connect(), $sql_class );
				  	$row_class = mysqli_fetch_array($result_class);
				  	$class_description = $row_class['class_description'];
				}
			 	if($_SESSION['username']=='sadmin') {
			 		$msg .= '<tr>
						<td>'.$i.'</td>
						<td>'.$row['stu_name'].'</td>
						<td>'.$row['father_name'].'</td>
						<td nowrap>'.date('d-m-Y' , strtotime($row['fee_submission_date'])).'</td>
						<td>'.$row['gender'].'</td>
						<td>'.$row['category'].'</td>
						<td>'.$row['mobile'].'</td>
						<td>'.$class_description.'</td>
						<td>'.$row['sub1'].'</td>						
						<td>'.$row['form_no'].'</td>
						<td>'.$row['e_mail1'].'</td>
						<td>'.$fee_type.'&nbsp;'.$row['receipt_number'].'</td>
						<td>'.$row['amount'].'</td>
						<td>'.$row['batch'].'</td>
						<td>'.$row['fee_submission_type'].'</td>';
						if($row['created_by'] != ''){
            				$msg .= '<td>'.$row_user['username'].'</td>';
        				}
        				else{
        					$msg .= '<td></td>';
        				}
						$msg .= '<td><a href="form_fee.php?id='.$row['sno'].'">Edit</a></td>
						<td><a href="form_fee_report.php?del='.$row['sno'].'">Delete</a></td>
						<td><a href="form_fee_print.php?id='.$row['sno'].'" target="_blank">Print</a></td>
						</tr>';
			 	}
			 	else{
             	$msg .= '<tr>
						<td>'.$i.'</td>
						<td>'.$row['stu_name'].'</td>
						<td>'.$row['father_name'].'</td>
						<td nowrap>'.date('d-m-Y' , strtotime($row['fee_submission_date'])).'</td>
						<td>'.$row['gender'].'</td>
						<td>'.$row['category'].'</td>
						<td>'.$row['mobile'].'</td>
						<td>'.$class_description.'</td>
						<td>'.$row['sub1'].'</td>						
						<td>'.$row['form_no'].'</td>
						<td>'.$row['e_mail1'].'</td>
						<td>'.$row['financial_year'].'/'.$fee_type.'&nbsp;'.$row['receipt_number'].'</td>
						<td>'.$row['amount'].'</td>
						<td>'.$row['batch'].'</td>
						<td>'.$row['fee_submission_type'].'</td>';
						if($row['created_by'] != ''){
            				$msg .= '<td>'.$row_user['username'].'</td>';
        				}
        				else{
        					$msg .= '<td></td>';
        				}
						$msg .= '<td></td>
						<td></td>
						<td><a href="form_fee_print.php?id='.$row['sno'].'" target="_blank">Print</a></td>
						</tr>';
					}
						$i++;
						$amount += $row['amount'];
				             }
	    

		$msg .= '<tr><th colspan="12" style="text-align:right;">Total:</th><th>'.$amount.'</th><th colspan="5"></th><tr></table>';
page_header_end();
page_sidebar();
	
	
?>
<style>
form div.row:nth-child(odd) {
  background: #eeeeee;
  border-radius: 5px;
  margin-bottom:5px;
  margin-top:5px;
  padding:5px;
}
form div.row label{
	color:#000000;
}
</style>
<script language="javascript" type="text/javascript">
	
	$( "#sale_date" ).datepicker({ dateFormat: 'yy-mm-dd' });
	$("#sale_date").change(function(){
		$( "#sale_date" ).datepicker("option", "showAnim", "slide");
	});

</script>
<script type="text/javascript" language="javascript" src="form_validator.js"></script>
	<div id="container">
		<div class="card">			
			<div class="card-body ">
				<div class="row d-flex my-auto">
					<div class="bg-primary text-white">
					<form action="form_fee_report.php" class="" name="feesdeposit" enctype="multipart/form-data" method="post" onSubmit="" autocomplete="off" >
						<h2 align="center" class="bg-primary text-white">Report </h2></div>
						
						 	
						<div class="col-md-12">
							<div class="row">							
								<div class="col-md-4">							
									<label>Enter Form No.</label>
									<input type="text" class="form-control" name="form_no" id="form_no" value="<?php if(isset($_POST['form_no'])){echo $_POST['form_no'];} ?>">
								</div>
								<div class="col-md-4">							
									<label>Enter Student Name</label>
									<input type="text" class="form-control"  name="stu_name" id="stu_name" value="<?php if(isset($_POST['stu_name'])){echo $_POST['stu_name'];} ?>">
								</div>
								<div class="col-md-4">							
									<label>Enter Father Name/Husband Name</label>
									<input type="text" name="father_name" class="form-control"  id="father_name" value="<?php if(isset($_POST['father_name'])){echo $_POST['father_name'];} ?>">
								</div>
							</div>
							<div class="row">							
								<div class="col-md-4">							
									<label>Class</label>
									<select name="class" class="form-control" >  
										<option value="">-SELECT ANY ONE-</option>
										<?php 
											$sql_class = 'SELECT * FROM `class_detail` order by `class_description` asc';
											$result_class = execute_query(connect(), $sql_class );
											while($row_class = mysqli_fetch_array($result_class)){
												?>
										<option value="<?php echo $row_class['sno']; ?>" <?php if(isset($_POST['class'])){if($_POST['class']==$row_class['sno']){echo 'selected';}} ?>><?php echo $row_class['class_description']; ?></option>
												<?php
											}
										?>
										<option value="phd_commerce" <?php if(isset($_POST['class'])){if($_POST['class']=='phd_commerce'){echo 'selected';}} ?>>PHD COMMERCE</option>
										<option value="phd_education" <?php if(isset($_POST['class'])){if($_POST['class']=='phd_education'){echo 'selected';}} ?>>PHD EDUCATION</option>
										<option value="phd_english" <?php if(isset($_POST['class'])){if($_POST['class']=='phd_english'){echo 'selected';}} ?>>PHD ENGLISH</option>
										<option value="phd_zoology" <?php if(isset($_POST['class'])){if($_POST['class']=='phd_zoology'){echo 'selected';}} ?>>PHD ZOOLOGY</option>
									</select>
								</div>
								<div class="col-md-4">							
									<label>Type</label>
									<select name="fee_submission_type" class="form-control" >
										<option value="">-SELECT ANY ONE-</option>
										<option value="Admission Form" <?php if(isset($_POST['fee_submission_type'])){if($_POST['fee_submission_type'] == 'Admission Form'){echo 'selected';}} ?>>Admission Form</option>
										<option value="Duplicate Form" <?php if(isset($_POST['fee_submission_type'])){if($_POST['fee_submission_type'] == 'Duplicate Form'){echo 'selected';}} ?>>Duplicate Form</option>
										<option value="tc_cc" <?php if(isset($_POST['fee_submission_type'])){if($_POST['fee_submission_type'] == 'tc_cc'){echo 'selected';}} ?>>TC/CC</option>
										<option value="miscellaneous" <?php if(isset($_POST['fee_submission_type'])){if($_POST['fee_submission_type'] == 'Miscellaneous'){echo 'selected';}} ?>>Miscellaneous</option>
										<option value="Research Inovation Fee" <?php if(isset($_POST['fee_submission_type'])){if($_POST['fee_submission_type'] == 'Research Inovation Fee'){echo 'selected';}} ?>>Research Inovation Fee</option>
									</select>
								</div>
								<div class="col-md-4">							
									<label>Gender</label>
									<select name="gender" class="form-control" >
										<option value="">-SELECT ANY ONE-</option>
										<option value="Male" <?php if(isset($_POST['gender'])){if($_POST['gender'] == 'Male'){echo 'selected';}} ?>>Male</option>
										<option value="Female" <?php if(isset($_POST['gender'])){if($_POST['gender'] == 'Female'){echo 'selected';}} ?>>Female</option>
									</select>
								</div>
							</div>
							<div class="row">							
								<div class="col-md-4">							
									<label>Category</label>
									<select name="category" class="form-control" >
										<option value="">-SELECT ANY ONE-</option>
										<option value="GEN" <?php if(isset($_POST['category'])){if($_POST['category'] == 'GEN'){echo 'selected';}} ?>>GEN</option>
										<option value="OBC" <?php if(isset($_POST['category'])){if($_POST['category'] == 'OBC'){echo 'selected';}} ?>>OBC</option>
										<option value="SC" <?php if(isset($_POST['category'])){if($_POST['category'] == 'SC'){echo 'selected';}} ?>>SC</option>
										<option value="ST" <?php if(isset($_POST['category'])){if($_POST['category'] == 'ST'){echo 'selected';}} ?>>ST</option>
									</select>
								</div>
								<div class="col-md-4">							
									<label>Date From</label>
									
									<script  type="text/javascript" language="javascript">document.writeln(DateInput('date_from', 'date_from', true, 'YYYY-MM-DD', '2023-02-27', 2));</script>
								</div>
								<div class="col-md-4">							
									<label>Date To</label>
									
									<script  type="text/javascript" language="javascript">document.writeln(DateInput('date_to', 'date_to', true, 'YYYY-MM-DD', '2023-02-27', 2));</script>
								</div>
							</div><br>
							<input type="submit" class="submit btn btn-primary" name="submit" value="Submit" />
							
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

          
	   <?php  
         page_footer_start();
         page_footer_end();
       ?>
  </div>
  
  
  
  
  
  
  
  
  
  
  	if(isset($_POST['submit'])){
		if($_POST['edit_sno']==''){
		$sql = 'insert into dp_personal_info (full_name, father_name, date_of_birth, religion, caste, sub_caste, gender, email, c_number, address, aadhar_number,aadhar_file, pan_number, pan_file) values ("'.$_POST['full_name'].'", "'.$_POST['father_name'].'","'.$_POST['date_of_birth'].'","'.$_POST['religion'].'","'.$_POST['caste'].'","'.$_POST['sub_caste'].'","'.$_POST['gender'].'","'.$_POST['email'].'","'.$_POST['c_number'].'","'.$_POST['address'].'","'.$_POST['aadhar_number'].'", "'.$_FILES['aadhar_file']['name'].'","'.$_POST['pan_number'].'", "'.$_FILES['pan_file']['name'].'")'; 
		}
		else{
		$sql = 'update dp_personal_info set full_name="'.$_POST['full_name'].'", father_name="'.$_POST['father_name'].'", date_of_birth="'.$_POST['date_of_birth'].'", religion="'.$_POST['religion'].'", caste="'.$_POST['caste'].'", gender="'.$_POST['gender'].'", email="'.$_POST['email'].'", c_number="'.$_POST['c_number'].'", address="'.$_POST['address'].'", aadhar_number="'.$_POST['aadhar_number'].'", aadhar_file="'.$_POST['aadhar_file'].'", pan_number="'.$_POST['pan_number'].'", pan_file="'.$_POST['pan_file'].'", class_name="'.$_POST['class_name'].'", college_name="'.$_POST['college_name'].'", board_name="'.$_POST['board_name'].'", roll_number="'.$_POST['roll_number'].'", obtained_marks="'.$_POST['obtained_marks'].'", percentage="'.$_POST['percentage'].'", grade="'.$_POST['grade'].'", file_name="'.$_POST['file_name'].'" where full_name="'.$_POST['edit_sno'].'"';
	}
	
		mysqli_query($con, $sql);
		if(mysqli_error($con)){ 
			$msg .= '<p class="text text-danger">Error # 1 : '.mysqli_error($con).'>> '.$sql.'</p>';
		}
		else{
			$msg .= '<p class="text text-success">Data Saved</p>';
			$id = mysqli_insert_id($con);
			
			move_uploaded_file ($_FILES['aadhar_file']['tmp_name'], "img/aadhar/".$_FILES['aadhar_file']['name']);
			move_uploaded_file ($_FILES['pan_file']['tmp_name'], "img/pan/".$_FILES['pan_file']['name']);
		
			$sql = 'insert into dp_qulification (personal_info_id, class_id, college_name, board_name, roll_number, obtained_marks, percentage, grade, file_name) values ("'.$id.'", "'.$_POST['class_id'].'","'.$_POST['college_name'].'", "'.$_POST['board_name'].'","'.$_POST['roll_number'].'","'.$_POST['obtained_marks'].'","'.$_POST['percentage'].'","'.$_POST['grade'].'","'.$_FILES['file_name']['name'].'")';
			mysqli_query($con, $sql);
				if(mysqli_error($con)){ 
					$msg .= '<p class="text text-danger">Error # 1 : '.mysqli_error($con).'>> '.$sql.'</p>';
				}
				else{
					$msg .= '<p class="text text-success">Data Saved</p>';
					
					move_uploaded_file ($_FILES['file_name']['tmp_name'], "img/result/".$_FILES['file_name']['name']);
				
				$sql = 'insert into dp_miscellaneous (personal_info_id, title, file_name) values ("'.$id.'","'.$_POST['title'].'", "'.$_FILES['attachment']['name'].'")';
				mysqli_query($con, $sql);
			if(mysqli_error($con)){ 
				$msg .= '<p class="text text-danger">Error # 1 : '.mysqli_error($con).'>> '.$sql.'</p>';
			}
			else{
				$msg .= '<p class="text text-success">Data Saved</p>';
			}
  
			move_uploaded_file ($_FILES['attachment']['tmp_name'], "img/misc/".$_FILES['attachment']['name']);
		}
		}
	
	}
if(isset($_GET['del'])){
	$sql = 'delete from dp_personal_info where full_name="'.$_GET['del'].'"';
	mysqli_query($con, $sql);
	if(mysqli_error($con)){
		$msg .= '<h3 style="color:#ff0000;">Error in deleting . '.mysqli_error($con).' >> '.$sql.'</h3>';
	}
	else{
		$msg .= '<h3 style="color:#00ff00;">Deleted</h3>';
	}
}
if(isset($_GET['edit'])){
	$sql = 'select * from dp_personal_info where full_name="'.$_GET['edit'].'"';
	
	$row = mysqli_fetch_assoc(mysqli_query($con, $sql));
}





















if(isset($_POST['submit'])){
	
	$sql = 'insert into dp_bank_details(ac_number, ifsc_code, attached_check, nominee_name, nominee_dob, nominee_relation, nominee_mobile_no) values ("'.$_POST['ac_number'].'", "'.$_POST['ifsc_code'].'","'.$_FILES['attached_check']['name'].'","'.$_POST['nominee_name'].'","'.$_POST['nominee_dob'].'","'.$_POST['nominee_relation'].'","'.$_POST['nominee_mobile_no'].'")'; 
	
	mysqli_query($con, $sql);
	if(mysqli_error($con)){ 
		$msg .= '<p class="text text-danger">Error # 1 : '.mysqli_error($con).'>> '.$sql.'</p>';
	}
	else{
		$msg .= '<p class="text text-success">Data Saved</p>';
	}

	move_uploaded_file ($_FILES['attachment_check']['tmp_name'], "img/misc/".$_FILES['attachment_check']['name']);
}